<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"
    />
    <title>é«˜é€Ÿèº²é¿æ¸¸æˆ Â· H5</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100svh; /* ç§»åŠ¨ç«¯åœ°å€æ æ”¶èµ·é€‚é… */
        overflow: hidden;
      }

      #gameContainer {
        position: relative;
        background: #1a1a2e;
        border-radius: 10px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        width: 100vw;
        height: 100svh; /* ä½¿ç”¨å°è§†å£å•ä½ï¼Œé¿å…è½¯é”®ç›˜å½±å“ */
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
          env(safe-area-inset-bottom) env(safe-area-inset-left);
        touch-action: none; /* ç¦æ­¢ç³»ç»Ÿæ‰‹åŠ¿ï¼Œæ–¹ä¾¿è§¦æ§ */
      }

      #gameCanvas {
        display: block;
        background: #0f0f1e;
        width: 100%;
        height: 100%;
      }

      #ui {
        position: absolute;
        top: calc(16px + env(safe-area-inset-top));
        left: calc(16px + env(safe-area-inset-left));
        color: white;
        font-size: clamp(14px, 2.6vw, 18px);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        z-index: 10;
      }

      /* é¦–é¡µè¦†ç›–å±‚ */
      #homeOverlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.9),
          rgba(118, 75, 162, 0.9)
        );
        color: #fff;
        z-index: 30;
      }

      .home-title {
        font-size: clamp(24px, 6vw, 40px);
        font-weight: 800;
        text-align: center;
        line-height: 1.2;
        text-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
        margin-bottom: 18px;
        padding: 0 24px;
      }

      .home-sub {
        font-size: clamp(14px, 3.5vw, 18px);
        opacity: 0.9;
        margin-bottom: 28px;
      }

      .home-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 18px;
      }

      .btn {
        font-size: 16px;
        padding: 12px 22px;
        border-radius: 999px;
        border: none;
        color: #fff;
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      }
      .btn-primary {
        background: linear-gradient(135deg, #22d3ee, #6366f1);
      }
      .btn-secondary {
        background: linear-gradient(135deg, #fb7185, #f59e0b);
      }

      .home-top3 {
        background: rgba(0, 0, 0, 0.25);
        padding: 12px 14px;
        border-radius: 12px;
        width: min(86vw, 520px);
        backdrop-filter: blur(6px);
      }

      .top3-title {
        font-weight: 700;
        margin-bottom: 12px;
        opacity: 0.95;
        font-size: clamp(14px, 3.5vw, 18px);
      }
      .top3-list {
        list-style: none;
      }
      .top3-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 8px;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.15);
        font-size: clamp(13px, 3vw, 16px);
        line-height: 1.5;
      }
      .top3-item:last-child {
        border-bottom: none;
      }

      #gameOver {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        display: none;
        z-index: 20;
        background: rgba(0, 0, 0, 0.85);
        padding: 40px 30px;
        border-radius: 20px;
        border: 2px solid rgba(255, 71, 87, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        max-width: 90vw;
      }

      #gameOver h1 {
        font-size: clamp(36px, 8vw, 60px);
        margin-bottom: 25px;
        color: #ff4757;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
      }

      #gameOver p {
        font-size: clamp(16px, 4vw, 24px);
        margin-bottom: 20px;
        line-height: 1.6;
      }

      #gameOver .btn {
        font-size: clamp(14px, 3.5vw, 18px);
        padding: 12px 24px;
        margin: 8px 6px;
      }

      .instructions {
        position: absolute;
        bottom: calc(16px + env(safe-area-inset-bottom));
        right: calc(16px + env(safe-area-inset-right));
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
        text-align: right;
        z-index: 10;
      }

      /* è™šæ‹Ÿæ‘‡æ†ï¼ˆåŠ¨æ€å‡ºç°ï¼Œä¸é®æŒ¡ä¸»è§†é‡ï¼‰ */
      .joy-base,
      .joy-knob {
        position: absolute;
        pointer-events: none;
        z-index: 25;
        display: none;
      }
      .joy-base {
        width: 120px;
        height: 120px;
        margin: -60px 0 0 -60px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.35);
        background: rgba(255, 255, 255, 0.07);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35),
          inset 0 0 20px rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(6px);
      }
      .joy-knob {
        width: 56px;
        height: 56px;
        margin: -28px 0 0 -28px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.9);
        background: radial-gradient(circle at 30% 30%, #fff, #dbeafe);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      }

      /* æ’è¡Œæ¦œå¼¹å±‚ */
      #rankOverlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 40;
      }
      .rank-card {
        width: min(90vw, 560px);
        max-height: 80vh;
        overflow: auto;
        background: #141427;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
        padding: 24px 20px;
      }
      .rank-title {
        font-size: clamp(18px, 4vw, 24px);
        font-weight: 800;
        margin-bottom: 20px;
        text-align: center;
        color: #00ff88;
      }
      .rank-list {
        list-style: none;
        max-height: 60vh;
        overflow-y: auto;
      }
      .rank-item {
        display: flex;
        justify-content: space-between;
        padding: 14px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        font-size: clamp(13px, 3vw, 16px);
        transition: background 0.2s;
      }
      .rank-item:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .rank-item:last-child {
        border-bottom: none;
      }
      /* å‰ä¸‰åç‰¹æ®Šæ ·å¼ */
      .rank-item.top-rank {
        background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent);
        font-weight: 600;
        border-left: 3px solid #ffd700;
        padding-left: 12px;
      }
      .rank-item.top-rank:hover {
        background: linear-gradient(
          90deg,
          rgba(255, 215, 0, 0.15),
          transparent
        );
      }
      .rank-actions {
        margin-top: 20px;
        text-align: center;
      }

      /* ç»“æŸé¡µè¾“å…¥æ¡† */
      .input {
        padding: 14px 16px;
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        outline: none;
        width: min(280px, 80vw);
        font-size: clamp(14px, 3.5vw, 16px);
        transition: border-color 0.3s, background 0.3s;
      }
      .input:focus {
        border-color: #00ff88;
        background: rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <div id="gameContainer">
      <canvas id="gameCanvas"></canvas>

      <!-- Supabase JS SDK -->
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <!-- åŠ¨æ€è™šæ‹Ÿæ‘‡æ†ï¼ˆæŒ‡ä¸‹ä½ç½®å‡ºç°ï¼‰ -->
      <div id="joyBase" class="joy-base" aria-hidden="true"></div>
      <div id="joyKnob" class="joy-knob" aria-hidden="true"></div>

      <!-- é¦–é¡µè¦†ç›–å±‚ -->
      <div id="homeOverlay">
        <div class="home-title">é«˜é€Ÿèº²é¿ Â· è¿½å›é‡‘å°å½©</div>
        <div class="home-sub">
          æŒ‰ä½å±å¹•å‡ºç°è™šæ‹Ÿæ‘‡æ†ï¼Œèº²é¿æ•Œäººï¼ŒåšæŒè¶Šä¹…åˆ†è¶Šé«˜
        </div>
        <div class="home-actions">
          <button class="btn btn-primary" id="btnStart">å¼€å§‹æ¸¸æˆ</button>
          <button class="btn btn-secondary" id="btnRank">æ’è¡Œæ¦œ</button>
        </div>
        <div class="home-top3">
          <div class="top3-title">ä»Šæ—¥å‰ä¸‰</div>
          <ul class="top3-list" id="top3"></ul>
        </div>
      </div>

      <div id="ui">
        <div>å¾—åˆ†: <span id="score">0</span></div>
        <div>ç”Ÿå‘½: <span id="lives">â¤ï¸â¤ï¸â¤ï¸</span></div>
        <div>æ—¶é—´: <span id="time">0</span>s</div>
      </div>

      <div id="gameOver">
        <h1>æ¸¸æˆç»“æŸ!</h1>
        <p style="margin-bottom: 15px">
          æœ€ç»ˆå¾—åˆ†:
          <span id="finalScore" style="color: #00ff88; font-weight: 700"
            >0</span
          >
        </p>
        <p style="margin-bottom: 25px">
          å­˜æ´»æ—¶é—´:
          <span id="finalTime" style="color: #ffd700; font-weight: 700">0</span
          >ç§’
        </p>
        <div style="margin-bottom: 20px">
          <input
            id="playerName"
            class="input"
            maxlength="12"
            placeholder="è¾“å…¥å§“åä¸Šæ¦œ(2-12å­—ç¬¦)"
            style="
              margin-bottom: 12px;
              display: block;
              margin-left: auto;
              margin-right: auto;
            "
          />
          <button
            class="btn btn-primary"
            id="btnSubmitScore"
            style="width: min(280px, 80vw)"
          >
            æäº¤ä¸Šæ¦œ
          </button>
        </div>
        <div
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
          "
        >
          <button class="btn btn-secondary" id="btnShowRank">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
          <button class="btn btn-primary" onclick="restartGame()">
            å†æ¥ä¸€å±€
          </button>
          <button class="btn" style="background: #475569" onclick="backHome()">
            è¿”å›é¦–é¡µ
          </button>
        </div>
      </div>

      <div class="instructions">
        ç§»åŠ¨ç«¯ï¼šæŒ‰ä½å±å¹•æ‹–åŠ¨è™šæ‹Ÿæ‘‡æ†<br />
        ç”µè„‘ç«¯ï¼šWASD / æ–¹å‘é”®
      </div>

      <!-- æ’è¡Œæ¦œ -->
      <div id="rankOverlay">
        <div class="rank-card">
          <div class="rank-title">ä»Šæ—¥æ’è¡Œæ¦œ</div>
          <ul id="rankList" class="rank-list"></ul>
          <div class="rank-actions">
            <button class="btn" style="background: #475569" id="btnCloseRank">
              å…³é—­
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ========= Supabase é…ç½® =========
      const SUPABASE_URL = "https://upppvolvuxtlvinzdphd.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwcHB2b2x2dXh0bHZpbnpkcGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2OTk2NjYsImV4cCI6MjA3NzI3NTY2Nn0.n8Uukj_Bj2Zc1LWr0YJER5WCv0g3viFwDStVtTjjMbE";
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      let player = null; // æå‰å£°æ˜ï¼Œé¿å… resizeCanvas åˆæ¬¡æ‰§è¡Œæ—¶è®¿é—®åˆ°æœªåˆå§‹åŒ–çš„ player
      // é€Ÿåº¦å€ç‡ï¼ˆ?speed=1.2ï¼‰ä¸â€œæ¯ç§’è·¨è¶Šå¤šå°‘ä¸ªæœ€çŸ­è¾¹â€ï¼ˆ?spw=1.3ï¼‰
      const qs = new URLSearchParams(location.search);
      const SPEED_K = Math.max(
        0.5,
        Math.min(
          3.0,
          Number(qs.get("speed")) ||
            Number(localStorage.getItem("escape_speed_k") || 1) ||
            1
        )
      );
      // æ¯ç§’è·¨è¶Šâ€œæœ€çŸ­è¾¹â€çš„å±æ•°ï¼ˆé»˜è®¤ 1.8 å±/ç§’ï¼Œç¡®ä¿ä»»ä½•è®¾å¤‡æ‰‹æ„Ÿä¸€è‡´ä¸”é€‚ä¸­ï¼‰
      const SPEED_SCREENS = Math.max(
        0.6,
        Math.min(
          4.0,
          Number(qs.get("spw")) ||
            Number(localStorage.getItem("escape_spw") || 1.8) ||
            1.8
        )
      );
      const $ = (id) => document.getElementById(id);
      const homeOverlay = $("homeOverlay");
      const rankOverlay = $("rankOverlay");
      const rankList = $("rankList");
      const top3 = $("top3");
      const btnStart = $("btnStart");
      const btnRank = $("btnRank");
      const btnCloseRank = $("btnCloseRank");
      const btnSubmitScore = $("btnSubmitScore");
      const btnShowRank = $("btnShowRank");

      // è§†å£/ç¼©æ”¾å‚æ•°
      const viewport = { w: 0, h: 0, dpr, scale: 1 };
      let stars = []; // æå‰å£°æ˜ï¼Œé¿å… setupStars åœ¨é¦–æ¬¡ resize æ—¶è®¿é—®æœªåˆå§‹åŒ–å˜é‡
      function resizeCanvas() {
        const rect = document.getElementById("gameContainer");
        const w = rect.clientWidth;
        const h = rect.clientHeight;
        viewport.w = w;
        viewport.h = h;
        viewport.scale = Math.min(w, h) / 375; // ä»¥ iPhone 11 å®½åº¦ä¸ºåŸºå‡†
        canvas.style.width = w + "px";
        canvas.style.height = h + "px";
        canvas.width = Math.round(w * dpr);
        canvas.height = Math.round(h * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // åæ ‡ç³»ä»ä½¿ç”¨ CSS åƒç´ 

        // æ ¹æ®å±å¹•è°ƒæ•´ç©å®¶å¤§å°å’Œé€Ÿåº¦
        const r = Math.max(6, Math.min(12, Math.round(10 * viewport.scale))); // ç¼©å°ä¸€åŠ
        const minDim = Math.min(viewport.w, viewport.h);
        if (player) {
          player.radius = r;
          player.speed = minDim / 75; // æ›´æ–°é€Ÿåº¦ä»¥é€‚åº”æ–°çš„å±å¹•å°ºå¯¸
        }

        // é‡æ–°å¸ƒç½®æ˜Ÿç©º
        setupStars();
      }
      window.addEventListener("resize", resizeCanvas);

      // åˆå§‹åŒ–ç©å®¶å¯¹è±¡ï¼ˆé€Ÿåº¦ç›¸å¯¹äºå±å¹•å°ºå¯¸ï¼Œç¡®ä¿ä¸åŒåˆ†è¾¨ç‡ä½“éªŒä¸€è‡´ï¼‰
      const minDim = Math.min(window.innerWidth, window.innerHeight);
      player = {
        x: window.innerWidth / 2,
        y: window.innerHeight / 2,
        radius: 9, // ç¼©å°ä¸€åŠ (18 -> 9)
        speed: minDim / 75, // æ¯å¸§ç§»åŠ¨å±å¹•æœ€çŸ­è¾¹çš„ 1/75 (60Hzä¸‹çº¦1.25ç§’æ¨ªç©¿å±å¹•)
        color: "#00ff88",
        velX: 0,
        velY: 0,
        trail: [],
        targetX: null,
        targetY: null,
      };

      // ç„¶åè°ƒç”¨ resizeCanvas æ›´æ–°æ‰€æœ‰å‚æ•°
      resizeCanvas();

      // æ¸¸æˆçŠ¶æ€
      let gameState = {
        running: true,
        score: 0,
        lives: 3,
        startTime: Date.now(),
        particles: [],
        finalTime: 0, // ä¿å­˜æœ€ç»ˆæ—¶é—´,é¿å…åœç•™é¡µé¢å¯¼è‡´æ—¶é—´ç»§ç»­å¢åŠ 
      };

      // æ•Œäººæ•°ç»„
      let enemies = [];

      // é”®ç›˜è¾“å…¥ & è§¦æ§
      const keys = {};
      const control = {
        active: false,
        ox: 0,
        oy: 0,
        vx: 0,
        vy: 0,
        strength: 0,
      };
      const joyBase = document.getElementById("joyBase");
      const joyKnob = document.getElementById("joyKnob");
      const JOY_R = 60; // æ‘‡æ†åŠå¾„ï¼ˆCSS pxï¼‰
      document.addEventListener("keydown", (e) => {
        keys[e.key.toLowerCase()] = true;
      });
      document.addEventListener("keyup", (e) => {
        delete keys[e.key.toLowerCase()];
      });
      canvas.addEventListener(
        "pointerdown",
        (e) => {
          e.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º,å‡å°‘å»¶è¿Ÿ
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          control.active = true;
          control.ox = x;
          control.oy = y;
          control.vx = 0;
          control.vy = 0;
          control.strength = 0;
          // æ˜¾ç¤ºæ‘‡æ†
          joyBase.style.display = "block";
          joyKnob.style.display = "block";
          joyBase.style.left = x + "px";
          joyBase.style.top = y + "px";
          joyKnob.style.left = x + "px";
          joyKnob.style.top = y + "px";
        },
        { passive: false }
      );
      canvas.addEventListener(
        "pointermove",
        (e) => {
          if (!control.active) return;
          e.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º,å‡å°‘å»¶è¿Ÿ
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const dx = x - control.ox;
          const dy = y - control.oy;
          const dist = Math.hypot(dx, dy);
          const clamped = Math.min(JOY_R, dist);
          const nx = (dx / (dist || 1)) * clamped;
          const ny = (dy / (dist || 1)) * clamped;
          control.vx = dx / (dist || 1);
          control.vy = dy / (dist || 1);
          control.strength = clamped / JOY_R; // 0..1
          joyKnob.style.left = control.ox + nx + "px";
          joyKnob.style.top = control.oy + ny + "px";
        },
        { passive: false }
      );
      window.addEventListener(
        "pointerup",
        (e) => {
          e.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º,å‡å°‘å»¶è¿Ÿ
          control.active = false;
          control.vx = control.vy = control.strength = 0;
          joyBase.style.display = "none";
          joyKnob.style.display = "none";
        },
        { passive: false }
      );

      // æ•Œäººç±»
      class Enemy {
        constructor() {
          // éšæœºä»å››ä¸ªè¾¹ç•Œè¿›å…¥
          const side = Math.floor(Math.random() * 4);

          if (side === 0) {
            // ä¸Š
            this.x = Math.random() * viewport.w;
            this.y = -20;
          } else if (side === 1) {
            // å³
            this.x = viewport.w + 20;
            this.y = Math.random() * viewport.h;
          } else if (side === 2) {
            // ä¸‹
            this.x = Math.random() * viewport.w;
            this.y = viewport.h + 20;
          } else {
            // å·¦
            this.x = -20;
            this.y = Math.random() * viewport.h;
          }

          // è®¡ç®—æœå‘ç©å®¶çš„é€Ÿåº¦å‘é‡
          const angle = Math.atan2(player.y - this.y, player.x - this.x);

          // æ•Œäººé€Ÿåº¦ï¼ˆç›¸å¯¹äºå±å¹•å°ºå¯¸ï¼Œç¡®ä¿ä¸åŒåˆ†è¾¨ç‡ä½“éªŒä¸€è‡´ï¼‰
          const minDim = Math.min(viewport.w, viewport.h);
          const baseSpeed = minDim / 95; // åŸºç¡€é€Ÿåº¦ï¼šå±å¹•æœ€çŸ­è¾¹çš„ 1/95
          const speed = baseSpeed + Math.random() * baseSpeed; // 1x ~ 2x åŸºç¡€é€Ÿåº¦

          this.velX = Math.cos(angle) * speed;
          this.velY = Math.sin(angle) * speed;

          // éšæœºå¤§å°ï¼ˆéšå±å¹•ç¼©æ”¾ï¼‰
          this.radius = Math.max(
            6,
            Math.min(18, 10 * viewport.scale + Math.random() * 8)
          );

          // éšæœºé¢œè‰²
          const colors = [
            "#ff4757",
            "#ff6348",
            "#ff7f50",
            "#ffa502",
            "#ff6b81",
          ];
          this.color = colors[Math.floor(Math.random() * colors.length)];

          this.rotation = 0;
          this.rotationSpeed = (Math.random() - 0.5) * 0.2; // å›ºå®šæ—‹è½¬é€Ÿåº¦
        }

        update() {
          // ä¸ä½¿ç”¨dtï¼Œæ¯å¸§å›ºå®šç§»åŠ¨
          this.x += this.velX;
          this.y += this.velY;
          this.rotation += this.rotationSpeed;

          // ç§»å‡ºå±å¹•å¾ˆè¿œå°±åˆ é™¤
          return !(
            this.x < -100 ||
            this.x > viewport.w + 100 ||
            this.y < -100 ||
            this.y > viewport.h + 100
          );
        }

        draw() {
          ctx.save();
          ctx.translate(this.x, this.y);
          ctx.rotate(this.rotation);

          // ç»˜åˆ¶å¸¦æ—‹è½¬æ•ˆæœçš„å¤šè¾¹å½¢æ•Œäºº
          ctx.beginPath();
          const sides = 5;
          for (let i = 0; i < sides; i++) {
            const angle = (i / sides) * Math.PI * 2;
            const x = Math.cos(angle) * this.radius;
            const y = Math.sin(angle) * this.radius;
            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }
          ctx.closePath();

          // æ¸å˜å¡«å……
          const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.radius);
          gradient.addColorStop(0, this.color);
          gradient.addColorStop(1, this.color + "80");
          ctx.fillStyle = gradient;
          ctx.fill();

          // å¤–å‘å…‰(å‡å°‘æ¨¡ç³ŠåŠå¾„,æå‡æ€§èƒ½)
          ctx.shadowBlur = 10; // ä»20é™åˆ°10
          ctx.shadowColor = this.color;
          ctx.strokeStyle = this.color;
          ctx.lineWidth = 2;
          ctx.stroke();

          ctx.restore();
        }
      }

      // ç²’å­æ•ˆæœç±»
      class Particle {
        constructor(x, y, color) {
          this.x = x;
          this.y = y;
          // ç²’å­é€Ÿåº¦ï¼ˆpx/sï¼‰
          this.velX = (Math.random() - 0.5) * 240 * viewport.scale;
          this.velY = (Math.random() - 0.5) * 240 * viewport.scale;
          this.radius = Math.random() * 3 + 1;
          this.color = color;
          this.life = 1;
          this.decay = 1.2 + Math.random(); // æ¯ç§’è¡°å‡é‡
        }

        update(dt) {
          this.x += this.velX * dt;
          this.y += this.velY * dt;
          this.velX *= Math.pow(0.98, dt * 60);
          this.velY *= Math.pow(0.98, dt * 60);
          this.life -= this.decay * dt;
          return this.life > 0;
        }

        draw() {
          ctx.save();
          ctx.globalAlpha = this.life;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.fillStyle = this.color;
          // ç²’å­ä¸éœ€è¦é˜´å½±,æå‡æ€§èƒ½
          // ctx.shadowBlur = 10;
          // ctx.shadowColor = this.color;
          ctx.fill();
          ctx.restore();
        }
      }

      // ç”Ÿæˆæ•Œäºº
      function spawnEnemy() {
        enemies.push(new Enemy());
      }

      // æ£€æµ‹ç¢°æ’
      function checkCollision(obj1, obj2) {
        const dx = obj1.x - obj2.x;
        const dy = obj1.y - obj2.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        return distance < obj1.radius + obj2.radius;
      }

      // åˆ›å»ºçˆ†ç‚¸ç²’å­(é™åˆ¶æ€»æ•°,é¿å…æ€§èƒ½é—®é¢˜)
      const MAX_PARTICLES = 150; // æœ€å¤§ç²’å­æ•°
      function createExplosion(x, y, color, count = 20) {
        // å¦‚æœç²’å­å¤ªå¤š,å…ˆåˆ é™¤æ—§çš„
        if (gameState.particles.length > MAX_PARTICLES - count) {
          gameState.particles = gameState.particles.slice(
            -(MAX_PARTICLES - count)
          );
        }
        for (let i = 0; i < count; i++) {
          gameState.particles.push(new Particle(x, y, color));
        }
      }

      // æ›´æ–°ç©å®¶
      function updatePlayer(dt) {
        // è™šæ‹Ÿæ‘‡æ†ä¼˜å…ˆ
        if (control.active) {
          // ç›´æ¥ä½¿ç”¨å›ºå®šé€Ÿåº¦ï¼Œä¸ä¾èµ–æ—¶é—´å¢é‡
          player.velX = control.vx * player.speed;
          player.velY = control.vy * player.speed;
        } else {
          // é”®ç›˜æ§åˆ¶
          player.velX = 0;
          player.velY = 0;
          if (keys["w"] || keys["arrowup"]) player.velY = -player.speed;
          if (keys["s"] || keys["arrowdown"]) player.velY = player.speed;
          if (keys["a"] || keys["arrowleft"]) player.velX = -player.speed;
          if (keys["d"] || keys["arrowright"]) player.velX = player.speed;
          // å¯¹è§’çº¿ç§»åŠ¨æ—¶å½’ä¸€åŒ–é€Ÿåº¦
          if (player.velX !== 0 && player.velY !== 0) {
            player.velX *= 0.707;
            player.velY *= 0.707;
          }
        }

        // æ›´æ–°ä½ç½®ï¼ˆä¸ä½¿ç”¨dtï¼Œæ¯å¸§å›ºå®šç§»åŠ¨ï¼‰
        player.x += player.velX;
        player.y += player.velY;

        // è¾¹ç•Œé™åˆ¶
        player.x = Math.max(
          player.radius,
          Math.min(viewport.w - player.radius, player.x)
        );
        player.y = Math.max(
          player.radius,
          Math.min(viewport.h - player.radius, player.y)
        );

        // è½¨è¿¹æ•ˆæœ
        player.trail.push({ x: player.x, y: player.y, alpha: 0.5 });
        if (player.trail.length > 10) {
          player.trail.shift();
        }
      }

      // ç»˜åˆ¶ç©å®¶
      function drawPlayer() {
        // ç»˜åˆ¶è½¨è¿¹
        player.trail.forEach((pos, index) => {
          const alpha = (index / player.trail.length) * 0.3;
          const size =
            player.radius * (0.5 + (index / player.trail.length) * 0.5);
          ctx.save();
          ctx.globalAlpha = alpha;
          ctx.beginPath();
          ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
          ctx.fillStyle = player.color;
          ctx.fill();
          ctx.restore();
        });

        // ç»˜åˆ¶ç©å®¶ä¸»ä½“
        ctx.save();
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);

        const gradient = ctx.createRadialGradient(
          player.x,
          player.y,
          0,
          player.x,
          player.y,
          player.radius
        );
        gradient.addColorStop(0, "#ffffff");
        gradient.addColorStop(0.5, player.color);
        gradient.addColorStop(1, player.color + "80");

        ctx.fillStyle = gradient;
        ctx.shadowBlur = 15; // ä»20é™åˆ°15,æå‡æ€§èƒ½
        ctx.shadowColor = player.color;
        ctx.fill();

        // å¤–åœˆ
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
      }

      // æ›´æ–°UI
      function updateUI() {
        document.getElementById("score").textContent = gameState.score;
        document.getElementById("lives").textContent = "â¤ï¸".repeat(
          gameState.lives
        );
        const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
        document.getElementById("time").textContent = elapsed;
      }

      // æ¸¸æˆç»“æŸ
      function gameOver() {
        gameState.running = false;
        // ä¿å­˜æœ€ç»ˆæ—¶é—´,é¿å…åœç•™åœ¨ç»“æŸé¡µé¢å¯¼è‡´æ—¶é—´ç»§ç»­å¢åŠ 
        gameState.finalTime = Math.floor(
          (Date.now() - gameState.startTime) / 1000
        );
        document.getElementById("finalScore").textContent = gameState.score;
        document.getElementById("finalTime").textContent = gameState.finalTime;
        document.getElementById("gameOver").style.display = "block";
        // é»˜è®¤å¡«å……ä¸€ä¸ªä¸Šæ¬¡çš„åå­—
        const last = localStorage.getItem("escape_last_name") || "";
        if (last) document.getElementById("playerName").value = last;
      }

      // é‡æ–°å¼€å§‹
      function restartGame() {
        gameState = {
          running: true,
          score: 0,
          lives: 3,
          startTime: Date.now(),
          particles: [],
          finalTime: 0,
        };
        enemies = [];
        player.x = viewport.w / 2;
        player.y = viewport.h / 2;
        player.trail = [];
        document.getElementById("gameOver").style.display = "none";
        gameLoop();
      }

      function backHome() {
        document.getElementById("gameOver").style.display = "none";
        showHome();
      }

      // ç»˜åˆ¶æ˜Ÿç©ºèƒŒæ™¯
      function setupStars() {
        const count = Math.round(90 * viewport.scale + 40); // éšå±å¹•ç¼©æ”¾
        stars = [];
        for (let i = 0; i < count; i++) {
          stars.push({
            x: Math.random() * viewport.w,
            y: Math.random() * viewport.h,
            radius: Math.random() * 2 + 0.4,
            alpha: Math.random(),
          });
        }
      }

      function drawBackground(dt) {
        ctx.fillStyle = "#0f0f1e";
        ctx.fillRect(0, 0, viewport.w, viewport.h);

        // ç»˜åˆ¶æ˜Ÿæ˜Ÿ
        stars.forEach((star) => {
          ctx.save();
          ctx.globalAlpha = star.alpha;
          ctx.beginPath();
          ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
          ctx.fillStyle = "#ffffff";
          ctx.fill();
          ctx.restore();

          // é—ªçƒæ•ˆæœ
          star.alpha += (Math.random() - 0.5) * 0.1 * dt * 60;
          star.alpha = Math.max(0.2, Math.min(1, star.alpha));
        });
      }

      // ä¸»æ¸¸æˆå¾ªç¯
      let lastSpawnTime = Date.now();
      let spawnInterval = 800; // åˆå§‹ç”Ÿæˆé—´éš”
      let hiddenAt = 0; // é¡µé¢éšè—æ—¶åˆ»
      const MAX_ENEMIES = 30; // æœ€å¤§æ•Œäººæ•°é‡,é¿å…æ€§èƒ½é—®é¢˜

      let prevTs = null;
      function gameLoop(ts) {
        if (!gameState.running) return;
        if (typeof ts !== "number") ts = performance.now();
        if (prevTs == null) prevTs = ts;
        let dt = (ts - prevTs) / 1000;
        prevTs = ts;
        // clampï¼Œé¿å…åˆ‡åå°æˆ–æ‰å¸§å¯¼è‡´å¤§æ­¥è·³
        dt = Math.max(0.001, Math.min(dt, 0.033));

        // æ¸…ç©ºç”»å¸ƒ
        drawBackground(dt);

        // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
        gameState.particles = gameState.particles.filter((particle) => {
          const alive = particle.update(dt);
          if (alive) particle.draw();
          return alive;
        });

        // ç”Ÿæˆæ•Œäººï¼ˆéšç€æ—¶é—´åŠ å¿« & è®¾å¤‡ç¼©æ”¾ï¼‰
        const now = Date.now();
        const elapsed = (now - gameState.startTime) / 1000;
        const accel = 10 * viewport.scale;
        spawnInterval = Math.max(260, 820 - elapsed * accel); // è¶Šæ¥è¶Šå¿«

        // é™åˆ¶æ•Œäººæ•°é‡,é¿å…æ€§èƒ½é—®é¢˜
        if (
          now - lastSpawnTime > spawnInterval &&
          enemies.length < MAX_ENEMIES
        ) {
          spawnEnemy();
          lastSpawnTime = now;
        }

        // æ›´æ–°å’Œç»˜åˆ¶æ•Œäºº
        enemies = enemies.filter((enemy) => {
          const alive = enemy.update(); // ä¸ä¼ dt
          if (alive) {
            enemy.draw();

            // æ£€æµ‹ç¢°æ’
            if (checkCollision(player, enemy)) {
              gameState.lives--;
              createExplosion(player.x, player.y, player.color, 30);
              createExplosion(enemy.x, enemy.y, enemy.color, 20);

              if (gameState.lives <= 0) {
                gameOver();
              }
              return false; // ç§»é™¤æ•Œäºº
            }
          }
          return alive;
        });

        // æ›´æ–°å’Œç»˜åˆ¶ç©å®¶
        updatePlayer(dt);
        drawPlayer();

        // å¾—åˆ†ï¼ˆåŸºäºæ—¶é—´ï¼‰
        gameState.score = Math.floor(elapsed * 10);

        // æ›´æ–°UI
        updateUI();

        requestAnimationFrame(gameLoop);
      }

      // ========= æ’è¡Œæ¦œé€»è¾‘ (Supabase + localStorage åŒå­˜å‚¨) =========
      const LB_KEY = "escape_leaderboard_v1";

      // ä» localStorage åŠ è½½ï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
      function loadLB() {
        try {
          return JSON.parse(localStorage.getItem(LB_KEY) || "[]");
        } catch (e) {
          return [];
        }
      }

      // ä¿å­˜åˆ° localStorageï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
      function saveLB(list) {
        localStorage.setItem(LB_KEY, JSON.stringify(list));
      }

      // ä» Supabase åŠ è½½æ’è¡Œæ¦œ
      async function loadLBFromSupabase() {
        try {
          const { data, error } = await supabase
            .from("leaderboard")
            .select("*")
            .order("score", { ascending: false })
            .order("time", { ascending: false })
            .limit(50);

          if (error) {
            console.error("Supabase åŠ è½½å¤±è´¥:", error);
            return loadLB(); // é™çº§åˆ° localStorage
          }

          // è½¬æ¢æ•°æ®æ ¼å¼
          const list = data.map((item) => ({
            name: item.name,
            score: item.score,
            time: item.time,
            ts: new Date(item.created_at).getTime(),
          }));

          // åŒæ­¥åˆ° localStorage ä½œä¸ºå¤‡ä»½
          saveLB(list);
          return list;
        } catch (e) {
          console.error("Supabase åŠ è½½å¼‚å¸¸:", e);
          return loadLB(); // é™çº§åˆ° localStorage
        }
      }

      // æ·»åŠ åˆ†æ•°ï¼ˆåŒæ—¶ä¿å­˜åˆ° Supabase å’Œ localStorageï¼‰
      async function addScore(name, score, time) {
        try {
          // ä¿å­˜åˆ° Supabase
          const { error } = await supabase
            .from("leaderboard")
            .insert([{ name, score, time }]);

          if (error) {
            console.error("Supabase ä¿å­˜å¤±è´¥:", error);
          }
        } catch (e) {
          console.error("Supabase ä¿å­˜å¼‚å¸¸:", e);
        }

        // åŒæ—¶ä¿å­˜åˆ° localStorage ä½œä¸ºå¤‡ä»½
        const list = loadLB();
        list.push({ name, score, time, ts: Date.now() });
        list.sort(
          (a, b) => b.score - a.score || a.time - b.time || a.ts - b.ts
        );
        saveLB(list.slice(0, 50));
      }

      // æ¸²æŸ“å‰ä¸‰å
      async function renderTop3() {
        const list = (await loadLBFromSupabase()).slice(0, 3);
        if (list.length === 0) {
          top3.innerHTML =
            '<li class="top3-item"><span>æš‚æ— æ•°æ®</span><span>-</span></li>';
          return;
        }
        top3.innerHTML = list
          .map(
            (it, idx) =>
              `<li class="top3-item"><span>${idx + 1}. ${escapeHtml(
                it.name
              )}</span><span>${it.score} åˆ† / ${it.time}s</span></li>`
          )
          .join("");
      }

      // æ¸²æŸ“æ’è¡Œæ¦œ - æ˜¾ç¤ºæ‰€æœ‰äºº,å‰ä¸‰åæœ‰ç‰¹æ®Šæ ‡è¯†
      async function renderRank() {
        const list = await loadLBFromSupabase(); // æ˜¾ç¤ºæ‰€æœ‰äºº,ä¸é™åˆ¶æ•°é‡
        if (list.length === 0) {
          rankList.innerHTML =
            '<li class="rank-item"><span>æš‚æ— æ•°æ®</span><span>-</span></li>';
          return;
        }

        // å¥–ç‰Œå›¾æ ‡
        const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"];

        rankList.innerHTML = list
          .map((it, idx) => {
            const rank = idx + 1;
            const medal = rank <= 3 ? medals[idx] : "";
            const rankClass = rank <= 3 ? "rank-item top-rank" : "rank-item";
            const rankDisplay = medal ? `${medal} ${rank}` : `#${rank}`;

            return `<li class="${rankClass}"><span>${rankDisplay} ${escapeHtml(
              it.name
            )}</span><span>${it.score}åˆ† Â· ${it.time}s</span></li>`;
          })
          .join("");
      }
      function escapeHtml(str) {
        return String(str || "").replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      function showHome() {
        homeOverlay.style.display = "flex";
        rankOverlay.style.display = "none";
        renderTop3();
      }
      function startGame() {
        homeOverlay.style.display = "none";
        document.getElementById("gameOver").style.display = "none";
        restartGame();
      }
      function openRank() {
        renderRank();
        rankOverlay.style.display = "flex";
      }
      function closeRank() {
        rankOverlay.style.display = "none";
      }

      btnStart.addEventListener("click", startGame);
      btnRank.addEventListener("click", openRank);
      btnCloseRank.addEventListener("click", closeRank);
      if (btnShowRank) btnShowRank.addEventListener("click", openRank);
      btnSubmitScore.addEventListener("click", async () => {
        const name = (document.getElementById("playerName").value || "").trim();
        if (!/^.{2,12}$/.test(name)) {
          alert("è¯·è¾“å…¥2-12ä¸ªå­—ç¬¦çš„æ˜µç§°");
          return;
        }
        localStorage.setItem("escape_last_name", name);
        // ä½¿ç”¨ä¿å­˜çš„æœ€ç»ˆæ—¶é—´,è€Œä¸æ˜¯é‡æ–°è®¡ç®—(é¿å…åœç•™é¡µé¢å¯¼è‡´æ—¶é—´å¢åŠ )
        const time = gameState.finalTime;

        // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
        btnSubmitScore.disabled = true;
        btnSubmitScore.textContent = "æäº¤ä¸­...";

        await addScore(name, gameState.score, time);

        btnSubmitScore.disabled = false;
        btnSubmitScore.textContent = "æäº¤ä¸Šæ¦œ";

        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById("playerName").value = "";

        alert("å·²æäº¤ä¸Šæ¦œï¼");
        await renderRank();
      });

      // é¡µé¢å¯è§æ€§ï¼šåå°æš‚åœè®¡æ—¶ï¼ˆä¸å½±å“å¾—åˆ† fairnessï¼‰
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) hiddenAt = Date.now();
        else if (hiddenAt) {
          gameState.startTime += Date.now() - hiddenAt;
          hiddenAt = 0;
        }
      });

      // é»˜è®¤æ˜¾ç¤ºé¦–é¡µ
      showHome();
    </script>
  </body>
</html>
