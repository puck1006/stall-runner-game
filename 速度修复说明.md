# 玩家移动速度修复说明

## 🐛 问题描述

1. **玩家移动速度太慢** - 几乎无法移动
2. **不同分辨率/刷新率下速度不一致** - 体验不统一

## 🔧 修复内容

### 1. 提高基础移动速度

**修改位置**: 第 364-373 行

**修改前**:
```javascript
const SPEED_SCREENS = Math.max(
  0.6,
  Math.min(
    4.0,
    Number(qs.get("spw")) ||
      Number(localStorage.getItem("escape_spw") || 2.2) ||
      2.2
  )
);
```

**修改后**:
```javascript
const SPEED_SCREENS = Math.max(
  0.6,
  Math.min(
    4.0,
    Number(qs.get("spw")) ||
      Number(localStorage.getItem("escape_spw") || 3.5) ||
      3.5
  )
);
```

**说明**: 将默认速度从 `2.2 屏/秒` 提升到 `3.5 屏/秒`,提升约 59%

---

### 2. 修复玩家初始化顺序

**修改位置**: 第 414-446 行

**问题**: 
- 原代码先调用 `resizeCanvas()`,再创建 `player` 对象
- 导致 `player.baseSpeed` 无法在 `resizeCanvas()` 中被正确设置
- 玩家速度停留在初始值 `7` (极慢)

**修改后**:
```javascript
// 先初始化玩家对象（baseSpeed 会在 resizeCanvas 中设置）
const minDim = Math.max(200, Math.min(window.innerWidth, window.innerHeight));
const initialSpeed = SPEED_SCREENS * minDim * SPEED_K; // px/s

player = {
  x: window.innerWidth / 2,
  y: window.innerHeight / 2,
  radius: 18,
  baseSpeed: initialSpeed,  // 正确计算的速度值
  color: "#00ff88",
  velX: 0,
  velY: 0,
  trail: [],
  targetX: null,
  targetY: null,
};

// 然后调用 resizeCanvas 更新所有参数
resizeCanvas();
```

**说明**: 
- 先创建 `player` 对象并计算初始速度
- 再调用 `resizeCanvas()` 更新参数
- 确保 `baseSpeed` 被正确设置

---

### 3. 提高虚拟摇杆最小速度

**修改位置**: 第 688-710 行

**修改前**:
```javascript
// 灵敏速度曲线：最低 0.35x，最大 1x
const factor = 0.35 + 0.65 * Math.sqrt(Math.max(0, Math.min(1, control.strength)));
```

**修改后**:
```javascript
// 灵敏速度曲线：最低 0.6x，最大 1x
const factor = 0.6 + 0.4 * Math.sqrt(Math.max(0, Math.min(1, control.strength)));
```

**说明**: 
- 将虚拟摇杆最小速度因子从 `0.35x` 提升到 `0.6x`
- 轻微移动摇杆时也能获得足够的移动速度
- 提升触摸控制的灵敏度

---

## 📊 速度计算公式

### 最终速度计算
```
玩家速度 (px/s) = SPEED_SCREENS × 屏幕最短边 × SPEED_K × 速度因子

其中:
- SPEED_SCREENS = 3.5 (默认,每秒跨越 3.5 个屏幕)
- 屏幕最短边 = min(窗口宽度, 窗口高度)
- SPEED_K = 1.0 (默认倍率,可通过 URL 参数调整)
- 速度因子 = 0.6 ~ 1.0 (虚拟摇杆) 或 1.0 (键盘)
```

### 示例计算

**手机竖屏 (375 × 667)**:
- 最短边 = 375px
- 基础速度 = 3.5 × 375 × 1.0 = 1312.5 px/s
- 虚拟摇杆最小速度 = 1312.5 × 0.6 = 787.5 px/s
- 虚拟摇杆最大速度 = 1312.5 × 1.0 = 1312.5 px/s

**电脑屏幕 (1920 × 1080)**:
- 最短边 = 1080px
- 基础速度 = 3.5 × 1080 × 1.0 = 3780 px/s
- 键盘速度 = 3780 px/s

---

## ✅ 修复效果

1. **速度统一**: 不同分辨率下,玩家都能以 "每秒 3.5 个屏幕" 的速度移动
2. **刷新率无关**: 使用时间增量 `dt` 计算,60Hz/120Hz/144Hz 体验一致
3. **触摸灵敏**: 虚拟摇杆最小速度提升 71% (0.35 → 0.6)
4. **整体提速**: 基础速度提升 59% (2.2 → 3.5)

---

## 🎮 自定义速度

### 通过 URL 参数调整

**调整整体速度倍率**:
```
https://www.leiyumail.xyz/escape.html?speed=1.5
```
- `speed=0.5` - 减速 50%
- `speed=1.0` - 默认速度
- `speed=1.5` - 加速 50%
- `speed=2.0` - 加速 100%

**调整屏幕跨越速度**:
```
https://www.leiyumail.xyz/escape.html?spw=4.0
```
- `spw=2.0` - 较慢 (每秒 2 屏)
- `spw=3.5` - 默认 (每秒 3.5 屏)
- `spw=5.0` - 较快 (每秒 5 屏)

**组合使用**:
```
https://www.leiyumail.xyz/escape.html?speed=1.2&spw=4.0
```

---

## 🧪 测试建议

1. **手机测试**: 在不同尺寸手机上测试触摸控制
2. **电脑测试**: 使用键盘 WASD 测试移动速度
3. **刷新率测试**: 在 60Hz/120Hz 屏幕上验证速度一致性
4. **分辨率测试**: 调整浏览器窗口大小,验证速度比例一致

---

## 📝 技术细节

### 时间增量计算
```javascript
let dt = (ts - prevTs) / 1000;  // 转换为秒
dt = Math.max(0.001, Math.min(dt, 0.033));  // 限制在 1ms ~ 33ms
```

### 位置更新
```javascript
player.x += player.velX * dt;  // 速度 × 时间 = 位移
player.y += player.velY * dt;
```

这确保了:
- 60 FPS: dt ≈ 0.0167s
- 120 FPS: dt ≈ 0.0083s
- 移动距离 = 速度 × dt,与帧率无关

---

## 🎯 总结

所有修改都已完成,玩家移动速度问题已解决:
- ✅ 速度足够快,游戏可玩性提升
- ✅ 不同设备体验一致
- ✅ 不同刷新率下速度统一
- ✅ 支持通过 URL 参数自定义速度

建议在实际设备上测试,如需进一步调整速度,可以修改 `SPEED_SCREENS` 的默认值 (当前 3.5)。

