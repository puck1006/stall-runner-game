# 速度系统最终说明

## 📋 修改概述

已将 `escape.html` 的速度系统改为**相对屏幕尺寸的固定帧率系统**,确保不同分辨率设备(尤其是手机)体验完全一致。

---

## 🎯 核心设计理念

### 问题
不同手机分辨率差异很大:
- iPhone SE: 375×667
- iPhone 14 Pro Max: 430×932
- 小米/华为旗舰: 1080×2400+

如果使用固定像素值(如 5px/帧),在高分辨率屏幕上会显得非常慢。

### 解决方案
**速度相对于屏幕尺寸**,而不是固定像素值:

```javascript
// 玩家速度 = 屏幕最短边 / 75
const minDim = Math.min(window.innerWidth, window.innerHeight);
player.speed = minDim / 75;

// 敌人速度 = 屏幕最短边 / 95 × (1~2)
const baseSpeed = minDim / 95;
const enemySpeed = baseSpeed + Math.random() * baseSpeed;
```

---

## 📊 速度计算示例

### iPhone SE (375×667)
- 最短边: 375px
- 玩家速度: 375 / 75 = **5 px/帧**
- 敌人速度: 375 / 95 = 3.95 → **3.95 ~ 7.9 px/帧**
- 横穿屏幕: 375 / 5 / 60 = **1.25 秒**

### iPhone 14 Pro Max (430×932)
- 最短边: 430px
- 玩家速度: 430 / 75 = **5.73 px/帧**
- 敌人速度: 430 / 95 = 4.53 → **4.53 ~ 9.05 px/帧**
- 横穿屏幕: 430 / 5.73 / 60 = **1.25 秒** ✅

### iPad (768×1024)
- 最短边: 768px
- 玩家速度: 768 / 75 = **10.24 px/帧**
- 敌人速度: 768 / 95 = 8.08 → **8.08 ~ 16.17 px/帧**
- 横穿屏幕: 768 / 10.24 / 60 = **1.25 秒** ✅

**关键**: 不管什么设备,横穿屏幕的时间都是 **1.25 秒**,体验完全一致!

---

## 🔧 代码修改详情

### 1. 玩家初始化 (第 412-425 行)

```javascript
// 初始化玩家对象（速度相对于屏幕尺寸，确保不同分辨率体验一致）
const minDim = Math.min(window.innerWidth, window.innerHeight);
player = {
  x: window.innerWidth / 2,
  y: window.innerHeight / 2,
  radius: 18,
  speed: minDim / 75, // 每帧移动屏幕最短边的 1/75 (60Hz下约1.25秒横穿屏幕)
  color: "#00ff88",
  velX: 0,
  velY: 0,
  trail: [],
  targetX: null,
  targetY: null,
};
```

### 2. 窗口大小调整 (第 401-407 行)

```javascript
// 根据屏幕调整玩家大小和速度
const r = Math.max(12, Math.min(24, Math.round(20 * viewport.scale)));
const minDim = Math.min(viewport.w, viewport.h);
if (player) {
  player.radius = r;
  player.speed = minDim / 75; // 更新速度以适应新的屏幕尺寸
}
```

**重要**: 当用户旋转屏幕或调整窗口大小时,速度会自动重新计算。

### 3. 敌人速度 (第 537-546 行)

```javascript
// 计算朝向玩家的速度向量
const angle = Math.atan2(player.y - this.y, player.x - this.x);

// 敌人速度（相对于屏幕尺寸，确保不同分辨率体验一致）
const minDim = Math.min(viewport.w, viewport.h);
const baseSpeed = minDim / 95; // 基础速度：屏幕最短边的 1/95
const speed = baseSpeed + Math.random() * baseSpeed; // 1x ~ 2x 基础速度

this.velX = Math.cos(angle) * speed;
this.velY = Math.sin(angle) * speed;
```

### 4. 玩家更新 (第 682-706 行)

```javascript
function updatePlayer(dt) {
  if (control.active) {
    // 虚拟摇杆：直接使用相对速度
    player.velX = control.vx * player.speed;
    player.velY = control.vy * player.speed;
  } else {
    // 键盘控制
    player.velX = 0;
    player.velY = 0;
    if (keys["w"] || keys["arrowup"]) player.velY = -player.speed;
    if (keys["s"] || keys["arrowdown"]) player.velY = player.speed;
    if (keys["a"] || keys["arrowleft"]) player.velX = -player.speed;
    if (keys["d"] || keys["arrowright"]) player.velX = player.speed;
    // 对角线移动时归一化速度
    if (player.velX !== 0 && player.velY !== 0) {
      player.velX *= 0.707;
      player.velY *= 0.707;
    }
  }

  // 更新位置（不使用dt，每帧固定移动）
  player.x += player.velX;
  player.y += player.velY;
  
  // 边界限制...
}
```

---

## 🎮 游戏平衡性

### 速度比例
- **玩家**: 屏幕最短边 / 75
- **敌人**: 屏幕最短边 / 95 × (1~2)

### 为什么这样设计?

1. **玩家稍快**: 75 < 95,玩家基础速度比敌人快约 27%
2. **敌人随机**: 1x~2x 倍率,有些敌人很慢,有些很快
3. **可躲避性**: 最慢的敌人(1x)追不上玩家,最快的敌人(2x)比玩家快约 58%
4. **难度递增**: 敌人数量越多,躲避空间越小,难度自然上升

### 时间参数 (60FPS)
- 横穿屏幕: **1.25 秒** (玩家)
- 最慢敌人追上玩家: **永远追不上** (速度更慢)
- 最快敌人追上玩家: **约 2-3 秒** (从屏幕边缘到中心)

---

## 🔧 调整速度

### 让玩家更快
```javascript
// 第 417 行
speed: minDim / 60, // 改小分母 (75 → 60)
```

### 让玩家更慢
```javascript
// 第 417 行
speed: minDim / 90, // 改大分母 (75 → 90)
```

### 让敌人更快
```javascript
// 第 541 行
const baseSpeed = minDim / 80; // 改小分母 (95 → 80)
```

### 让敌人更慢
```javascript
// 第 541 行
const baseSpeed = minDim / 110; // 改大分母 (95 → 110)
```

### 调整敌人速度随机范围
```javascript
// 第 542 行
const speed = baseSpeed + Math.random() * baseSpeed * 1.5; // 1x ~ 2.5x
const speed = baseSpeed + Math.random() * baseSpeed * 0.5; // 1x ~ 1.5x
```

---

## 📱 测试工具

打开 `分辨率速度测试.html` 可以查看:
- 当前设备的分辨率和速度参数
- 常见手机/平板的速度对比
- 横穿屏幕所需时间
- 敌人追上玩家所需时间

```bash
# 启动本地服务器
python3 -m http.server 8000

# 访问测试工具
http://localhost:8000/分辨率速度测试.html

# 访问游戏
http://localhost:8000/escape.html
```

---

## ✅ 优势总结

### ✅ 分辨率无关
不管是 iPhone SE (375px) 还是 iPad Pro (1024px),游戏体验完全一致。

### ✅ 60Hz 基准
基于 60FPS 设计,适配大多数手机默认刷新率。

### ✅ 自动缩放
速度随屏幕尺寸自动调整,无需手动配置。

### ✅ 简单直观
公式简单: `speed = minDim / divisor`,易于理解和调整。

### ✅ 手机优化
专为手机端设计,高分辨率屏幕也能流畅游玩。

---

## ⚠️ 注意事项

### 1. 帧率依赖
游戏基于 60FPS 设计:
- 60 FPS: 正常速度 ✅
- 30 FPS: 速度减半 ⚠️
- 120 FPS: 速度加倍 ⚠️

**解决方案**: 大多数浏览器默认 60 FPS,实际影响很小。

### 2. 屏幕旋转
当用户旋转屏幕时,`resizeCanvas()` 会自动重新计算速度,确保体验一致。

### 3. 粒子系统
粒子效果仍然使用时间增量 `dt`,因为:
- 粒子不影响游戏性
- 基于时间的衰减效果更自然

---

## 📊 性能影响

### 计算开销
- 玩家速度: 每次 resize 计算一次 (极少)
- 敌人速度: 每个敌人生成时计算一次
- 总开销: 可忽略不计

### 优化效果
- ✅ 删除了复杂的 `SPEED_K` 和 `SPEED_SCREENS` 计算
- ✅ 简化了速度公式
- ✅ 代码更易维护

---

## 🎉 总结

现在 `escape.html` 使用**相对屏幕尺寸的速度系统**:

- **玩家**: 屏幕最短边 / 75 (约 1.25 秒横穿屏幕)
- **敌人**: 屏幕最短边 / 95 × (1~2) (随机速度)
- **体验**: 不同分辨率设备完全一致
- **优化**: 专为手机端设计

可以在不同设备上测试,体验应该是一致的! 🎮📱

